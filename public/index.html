<html>
<head>
<title>Future Day Spa</title>
<link rel="stylesheet" href="style/pure.css">
<link rel="stylesheet" href="style/visualization.css">
<script src="http://cdn.peerjs.com/0.3/peer.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="lib/arg-1.3.1.min.js"></script>
<script src="config.js"></script>
<script src="strings.js"></script>
<style>
#debug, div, h1, h2, h3, p {
  margin: .2em;
  padding: 0;
}
#their-video {
  position: absolute;
  top: 0;
  left: 0;
  width: 1280px;
  height: 720px;
}
#debug {
  border-radius: 4px;
  padding: 1em;
  position: fixed;
  left: 25px;
  bottom: 25px;
  background-color: white;
  color: black;
}
</style>
</head>

<body>

  <video id="their-video" autoplay></video>
  
  <div id="debug">
    <p><span id="latest-data">...</span></p>
  </div>

<script>
function leaveVoicemail() {
  if(window.existingCall) {
    return;
  }
  var query =
    '?clientId=' + peer.id +
    '&cameraId=' + config.cameraId;    
  $.get('voicemail' + query, function( data ) {
    console.log('Left a voicemail message ' + query);
  });
  setTimeout(leaveVoicemail, config.voicemailTimeout);
}

// PeerJS object
var peer = new Peer({ key: config.peerjsApiKey });

// Receiving a call
peer.on('call', function(call){
  // Answer the call automatically (instead of prompting user) for demo purposes
  // call.answer(window.localStream);
  call.answer();
  step3(call);
});
peer.on('error', function(err){
  // alert(err.message);
  // Return to step 2 if error occurs
  step2();
});

// Click handlers setup
$(function(){
  $('#camera-id').text(config.cameraId);

  $('#end-call').click(function(){
    hangUp();
    step2();
  });

  $('#refresh').click(function() {
    hangUp();
    location.reload();
  })

  // Get things started
  step2();
});

function hangUp() {
  // Hang up on an existing call if present
  if (window.existingCall) {
    window.existingCall.close();
    window.existingCall = null;
  }
}

function step2 () {
  hangUp();
  leaveVoicemail();
}

function step3 (call) {
  hangUp();

  // Wait for stream on the call, then set peer video display
  call.on('stream', function(stream){
    $('#their-video').prop('src', URL.createObjectURL(stream));
  });

  // UI stuff
  window.existingCall = call;
  $('#their-id').text(call.peer);
  call.on('close', step2);
}

var hrData;
var dataSocket = io.connect('http://qualcomm-lucymcrae.herokuapp.com/');
dataSocket.on('status', function (data) {
  console.log(data);
  dataSocket.emit('status', { client: location.href });
});
dataSocket.on('update', function (data) {
  console.log('Got heart rate update');
  console.log(data);
  $('#latest-data').text(data.hr + ' bpm / ' + data.spo2 + '%');
  if(data.serial == curSerial) {
    console.log('Updating records from database');
    $.getJSON('http://qualcomm-lucymcrae.herokuapp.com/get/data/?serial='+curSerial, function (data) {
      hrData = data;
    })
  }
});
</script>

</body>
</html>
