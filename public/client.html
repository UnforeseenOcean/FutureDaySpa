<html>
<head>
<title>Client</title>
<link rel="stylesheet" href="style/pure.css">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="http://cdn.peerjs.com/0.3/peer.js"></script>
<script src="lib/arg-1.3.1.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="config.js"></script>
<style>
body, html {
  margin: 0;
  padding: 0;
  width: 100%;
}
body {
  background-color: black;
}
#debug, div, h1, h2, h3, p {
  margin: .2em;
  padding: 0;
}
#their-video {
  position: absolute;
  top: 0;
  left: 0;
  width: 1280px;
  height: 720px;
}
#debug {
  border-radius: 4px;
  padding: 1em;
  position: fixed;
  left: 25px;
  bottom: 25px;
  background-color: white;
}
</style>
</head>

<body>

  <video id="their-video" autoplay></video>
  
  <div id="debug">

      <!-- Steps -->
      <div>
        <h2>Client <span id="camera-id">...</span></h2>

        <!-- Make calls to others -->
        <div id="step2">
          <p>Your id: <span id="my-id">...</span></p>
        </div>

        <!-- Call in progress -->
        <div id="step3">
          <p>Their id: <span id="their-id">...</span></p>
          <p><a href="#" class="pure-button pure-button-error" id="end-call">End call</a></p>
        </div>

        <!-- extra -->
        <div>
          <p><a href="#" class="pure-button" id="refresh">Refresh</a></p>
          <p>Resolution: <span id="resolution">...</span></p>
          <p>Latest data: <span id="latest-data">...</span></p>
        </div>
      </div>
  </div>

<script>
function leaveVoicemail() {
  if(window.existingCall) {
    return;
  }
  var query =
    '?clientId=' + peer.id +
    '&cameraId=' + Arg('cameraId');    
  $.get('voicemail' + query, function( data ) {
    console.log('Left a voicemail message ' + query);
  });
  setTimeout(leaveVoicemail, config.voicemailTimeout);
}

// PeerJS object
var peer = new Peer({ key: config.peerjsApiKey });

peer.on('open', function(){
  $('#my-id').text(peer.id);
  leaveVoicemail();
});

// Receiving a call
peer.on('call', function(call){
  // Answer the call automatically (instead of prompting user) for demo purposes
  // call.answer(window.localStream);
  call.answer();
  step3(call);
});
peer.on('error', function(err){
  // alert(err.message);
  // Return to step 2 if error occurs
  step2();
});

function updateResolution() {
  var resolution = $(window).width() + "x" + $(window).height();
  $('#resolution').text(resolution);
}

// Click handlers setup
$(function(){
  $('#camera-id').text(cameraId);

  $('#end-call').click(function(){
    hangUp();
    step2();
  });

  $('#refresh').click(function() {
    hangUp();
    location.reload();
  })

  updateResolution();

  // Get things started
  step1();
});

$(window).resize(function() {
  updateResolution();
});

function hangUp() {
  // Hang up on an existing call if present
  if (window.existingCall) {
    window.existingCall.close();
    window.existingCall = null;
  }
}

function step1 () {
  step2();
}

function step2 () {
  $('#step3').hide();
  $('#step2').show();
  hangUp();
  leaveVoicemail();
}

function step3 (call) {
  hangUp();

  // Wait for stream on the call, then set peer video display
  call.on('stream', function(stream){
    $('#their-video').prop('src', URL.createObjectURL(stream));
  });

  // UI stuff
  window.existingCall = call;
  $('#their-id').text(call.peer);
  call.on('close', step2);
  $('#step3').show();
}

var hrData;
var dataSocket = io.connect('http://qualcomm-lucymcrae.herokuapp.com/');
dataSocket.on('status', function (data) {
  console.log(data);
  dataSocket.emit('status', { client: location.href });
});
dataSocket.on('update', function (data) {
  console.log('Got heart rate update');
  console.log(data);
  $('#latest-data').text(data.hr + ' bpm / ' + data.spo2 + '%');
  if(data.serial == curSerial) {
    console.log('Updating records from database');
    $.getJSON('http://qualcomm-lucymcrae.herokuapp.com/get/data/?serial='+curSerial, function (data) {
      hrData = data;
    })
  }
});
</script>

</body>
</html>
